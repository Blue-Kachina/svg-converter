services:
  app:
    image: ${IMAGE:-svg-converter:latest}
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      APP_ENV: staging
      APP_DEBUG: 'false'
      LOG_CHANNEL: stderr
      OCTANE_SERVER: frankenphp
      OCTANE_WORKERS: 2
      OCTANE_MAX_REQUESTS: 250
      DB_CONNECTION: sqlite
      DB_DATABASE: database/database.sqlite
      METRICS_ENABLED: 'true'
      METRICS_EXPOSE: 'true'
      # Redis configuration
      REDIS_CLIENT: phpredis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # App services to use Redis
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
    ports:
      - "${APP_PORT:-8081}:80"
    volumes:
      - app_storage_staging:/app/storage
      - app_database_staging:/app/database
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/api/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
  redis:
    image: redis:7-alpine
    ports:
      - "${FORWARD_REDIS_PORT:-6379}:6379"
    restart: unless-stopped

  queue:
    image: ${IMAGE:-svg-converter:latest}
    entrypoint: ["/bin/sh", "-lc"]
    command: >-
      # Generate a runtime APP_KEY if not provided
      if [ -z "${APP_KEY:-}" ]; then APP_KEY="base64:$$(php -r 'echo base64_encode(random_bytes(32));')"; export APP_KEY; fi;
      # Ensure SQLite exists when configured
      DB_PATH="${DB_DATABASE:-database/database.sqlite}";
      if [ "${DB_CONNECTION:-}" = "sqlite" ] && [ ! -f "$$DB_PATH" ]; then
        mkdir -p "$$(dirname "$$DB_PATH")"; touch "$$DB_PATH";
      fi;
      php artisan config:cache || true;
      php artisan queue:work redis
      --queue=${QUEUE:-default}
      --sleep=${QUEUE_SLEEP:-1}
      --tries=${QUEUE_TRIES:-3}
      --backoff=${QUEUE_BACKOFF:-3}
      --timeout=${QUEUE_TIMEOUT:-90}
      --max-time=${QUEUE_MAX_TIME:-3600}
    environment:
      APP_ENV: staging
      APP_DEBUG: 'false'
      LOG_CHANNEL: stderr
      # Ensure Laravel can boot without the full entrypoint
      APP_KEY: ${APP_KEY:-}
      # Database (defaults to SQLite)
      DB_CONNECTION: ${DB_CONNECTION:-sqlite}
      DB_DATABASE: ${DB_DATABASE:-database/database.sqlite}
      REDIS_CLIENT: phpredis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      QUEUE_CONNECTION: redis
    volumes:
      - app_storage_staging:/app/storage
      - app_database_staging:/app/database
    depends_on:
      - redis
    restart: unless-stopped
    # Scale with: docker compose -f docker-compose.staging.yml up -d --scale queue=2

volumes:
  app_storage_staging:
  app_database_staging:
